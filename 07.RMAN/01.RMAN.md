## RMAN Backup and Restore:


### RMAN Backup Strategy:

_A typical production backup plan might include:_
- **Daily incremental level 1** backups.
- **Weekly full (level 0)** backups.
- **Archived log backups** every hour.
- **Control file and SPFILE** backup daily.
- Stored in **Fast Recovery Area (FRA)** or external storage.




### Prerequisites:

#### 1. One-time setup:

_Enable Archivelog:_
```
shutdown immediate;
startup mount;
alter database archivelog;
alter database open;
```


```
archive log list;
```


```
SELECT log_mode FROM v$database;

LOG_MODE
------------
ARCHIVELOG
```



```
alter system switch logfile;

select group#, members, sequence#, status from v$log;
```


```
ALTER SYSTEM ARCHIVE LOG CURRENT;

select name, sequence# from v$archived_log;
```




#### Set Archive Destination:

```
mkdir -p /u01/backup/rman/archivelog
```


```
ALTER SYSTEM SET log_archive_dest_1='LOCATION=/u01/backup/rman/archivelog' SCOPE=SPFILE;
```



_Check Current Archive Destination:_
```
SHOW PARAMETER log_archive_dest;

NAME                                 TYPE        VALUE
------------------------------------ ----------- --------------------------------------
log_archive_dest                     string
log_archive_dest_1                   string      LOCATION=/u01/backup/rman/archivelog
```



```
SHOW PARAMETER log_archive_format;

NAME                                 TYPE        VALUE
------------------------------------ ----------- -----------------
log_archive_format                   string      %t_%s_%r.dbf
```



> [!NOTE]  
> RMAN does not permit you to make inconsistent backups when the database is in `NOARCHIVELOG` mode.






#### Set FRA Destination:


_Check FRA Destination:_
```
show parameter recovery;

NAME                                 TYPE        VALUE
------------------------------------ ----------- -------------
db_recovery_file_dest                string
db_recovery_file_dest_size           big integer 0
recovery_parallelism                 integer     0
remote_recovery_file_dest            string
```



_Set Fast Recovery Area:_
```
mkdir -p /u01/backup/rman/fra
```


```
alter system set db_recovery_file_dest_size=20G scope=both;

alter system set db_recovery_file_dest='/u01/backup/rman/fra' scope=both;
```


```
select name from v$recovery_file_dest;

NAME
---------------------------
/u01/backup/rman/fra
```




#### 2. Create a dedicated OS directory for backups:

```
mkdir -p /u01/backup/rman/rman_bkp
chown oracle:oinstall /u01/backup/rman/rman_bkp
```


#### 3. RMAN configuration (once):

- `%d` : For database name
- `%T` : For date time
- `%U` : For random number
- `%F` : is a format specifier used by RMAN to generate a unique name for the control file autobackup.
    - `c-` : A literal prefix indicating a control file backup.
    - `1738843157` : The 10-digit database ID (DBID) of the database.
    - `YYYYMMDD` : The date in the format year (YYYY), month (MM), and day (DD).
    - `QQ` : A sequence number (hexadecimal, 00-FF) to ensure uniqueness within the same day.
- `%I` : DBID
- `%s` : Nackup set number
- `%p` : Piece number within the backup set
- `%t` : Backup set timestamp 



```
rman target /

Or,

rman target sys/orcl

rman target sys/sys@orcl
```


Or,

```
rman

RMAN> connect target sys@orcl

target database Password: password
connected to target database: ORCL (DBID=1738843XXX)
```


```
show all;


```


```
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;                  --> or REDUNDANCY 2

CONFIGURE RETENTION POLICY TO REDUNDANCY 2;

CONFIGURE BACKUP OPTIMIZATION ON;   

CONFIGURE DEFAULT DEVICE TYPE TO DISK;                                      --> or TAPE

CONFIGURE CONTROLFILE AUTOBACKUP ON;



CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/u01/backup/rman/rman_bkp/cf_%d_%F';     --> Controlfile autobackup location

CONFIGURE CHANNEL DEVICE TYPE DISK FORMAT '/u01/backup/rman/rman_bkp/%d_%T_%U';                           --> Database backup location


CONFIGURE DEVICE TYPE DISK PARALLELISM 1 BACKUP TYPE TO BACKUPSET;
CONFIGURE DEVICE TYPE DISK PARALLELISM 1;

CONFIGURE ARCHIVELOG DELETION POLICY TO APPLIED ON ALL STANDBY;            --> if Data Guard
```



_Set RMAN Parameter:_
```
CONFIGURE BACKUP OPTIMIZATION ON;
CONFIGURE CONTROLFILE AUTOBACKUP ON;
```



_Show changed parameter:_
```
select name, value from v$rman_configuration;

NAME                                              VALUE
----------------------------------------------    ---------------------------------------------------------------
CONTROLFILE AUTOBACKUP                            ON
BACKUP OPTIMIZATION                               ON
DEFAULT DEVICE TYPE TO                            DISK
CONTROLFILE AUTOBACK UP FORMAT FOR DEVICE TYPE    DISK TO '/u01/backup/rman/rman_bkp/cf_%d_%F'
CHANNEL                                           DEVICE TYPE DISK FORMAT '/u01/backup/rman/rman_bkp/%d_%T_%U'
```


__
```
select 
input_type, 
status,
to_char(start_time, 'dd-mm-yyyy hh24:mi:ss') as backup_start_time,
to_char(end_time, 'dd-mm-yyyy hh24:mi:ss') as backup_end_time,
elapsed_seconds / 3600 hours
from v$rman_backup_job_details
order by session_key;
```


```
select bs_key, pkey, fname, backup_type, file_type, bs_type, bs_completion_time, bytes /1024/1024, bs_bytes /1024/1024 
from v$backup_files
where file_type = 'PIECE'
order by bs_key, pkey;
```


```
select * from v$backup_archivelog_details;
```


```
select value from v$diag_info where name = 'Diag Trace';
```




#### 4. Recovery Catalog (Optional but recommended)

```
create user rman identified by "StrongPW" default tablespace users temporary tablespace temp quota unlimited on users;

grant connect, resource, recovery_catalog_owner to rman;
```



---
---



### RMAN Backup:

#### Full Database Backup:

```
report schema;
```


```
BACKUP DATABASE;                      --> Backups datafiles, control file and spfile

Or,

BACKUP DATABASE PLUS ARCHIVELOG;
```


```
backup database format ='/u01/backup/rman/rman_bkp/full_db_bkp_%d_%T_%U';

backup database plus archivelog format ='/u01/backup/rman/rman_bkp/full_db_arch_bkp_%d_%T_%U'; 

backup database plus archivelog format ='/u01/backup/rman/rman_bkp/full_db_arch_bkp_%d_%T_%U' tag="orcl_full_db";
```


#### Archived Log Backup:

```
BACKUP ARCHIVELOG ALL;                --> Backup only archive logs 

backup archivelog all format ='/u01/backup/rman/archivelog/arch_bkp_%d_%T_%U';

BACKUP ARCHIVELOG sequence 16;
```


#### Control File & SPFILE Backup:

```
BACKUP CURRENT CONTROLFILE;

backup current controlfile format '/backup/rman_backup/control_bkp_%d_%T_%U';
```


```
BACKUP SPFILE;

BACKUP spfile format '/backup/rman_backup/spfile_bkp_%d_%T_%U'; 
```


#### Parallel Backup: 

```
RUN
{
ALLOCATE CHANNEL ch1 device type disk;
ALLOCATE CHANNEL ch2 device type disk;
backup database format '/u01/backup/rman/rman_bkp/full_db_bkp_%d_%T_%U';
backup archivelog all format '/u01/backup/rman/archivelog/arch_bkp_%d_%T_%U';
RELEASE CHANNEL ch1;
RELEASE CHANNEL ch2;
}
```


#### Incremental Backup (Level 0):

```
BACKUP INCREMENTAL LEVEL 0 DATABASE;
BACKUP incremental level 0 DATABASE PLUS ARCHIVELOG;

BACKUP incremental level 0 DATABASE PLUS ARCHIVELOG format ='/u01/backup/rman/rman_bkp/level0_bkp_%d_%T_%U'; 
```



#### Incremental Backup (Level 1):

```
BACKUP INCREMENTAL LEVEL 1 DATABASE;

BACKUP incremental level 1 DATABASE PLUS ARCHIVELOG format ='/u01/backup/rman/rman_bkp/level1_bkp_%d_%T_%U'; 
```


#### Backup a Tablespace:

```
BACKUP tablespace users; 
BACKUP tablespace users, system; 
```



#### Backup a datafile:


```
backup datafile 7; 

backup datafile 7, 8; 

backup datafile '/u01/app/oracle/oradata/ORCL/system01.dbf';

BACKUP DATAFILE ‘/dboracle/customer.dbf’ to destination ‘/dbbackup/’;
```



#### Backup a table only:

```
BACKUP TABLESPACE customer to destination ‘/dbbackup/’;
```





### Verify and Validate:

_Displays on backups information:_
```
LIST BACKUP;
LIST BACKUP SUMMARY;

```


```
LIST ARCHIVELOG ALL;
```


_Identify Recent Backups:_
```
LIST BACKUP OF DATABASE;
LIST BACKUP OF DATABASE SUMMARY; 

LIST BACKUP OF ARCHIVELOG ALL;
LIST BACKUP OF ARCHIVELOG ALL SUMMARY;

LIST BACKUP OF CONTROLFILE;

LIST BACKUP OF SPFILE;

list backup of tablespace;
LIST BACKUP OF DATAFILE 7;
```


_To check status of backupset:_
```
CROSSCHECK BACKUP;

crosscheck backup of database;
crosscheck backup of datafile 7;
```


_To check status of archivelog:_
```
CROSSCHECK ARCHIVELOG ALL;

crosscheck backup of archivelog all;
```



_Validate Backups:_
```
VALIDATE DATABASE;                    --> logical & physical corruption checks

validate backupset 22;

VALIDATE DATAFILE 7; 
validate datafile 7 block 2;
```



```
RESTORE DATABASE VALIDATE;
RESTORE SPFILE VALIDATE;
```




### Delete Backups:

#### Delete All Backups: 

_To delete all the backups:_
```
DELETE BACKUP;

DELETE NOPROMPT BACKUP;
```



_Remove Database backups:_
```
LIST BACKUP OF DATABASE;

DELETE BACKUPSET 22;             --> To remove specific backups

DELETE NOPROMPT BACKUPSET 22;
```



#### Delete Archivelog Backups:

_To delete archivelog files from the **disk**:_
```
DELETE ARCHIVELOG ALL;

DELETE ARCHIVELOG UNTIL SEQUENCE 2454120;
```



#### Delete Expired Backups:

The RMAN backup and someone deleted backup set or backup pieces at **OS level**. The database CONTROFILE has the details of the backup on disk but at **OS level the backup file does not exists**. A backup is EXPIRED when the physical backup piece or image copy is not found at the expected location.

- Causes:
    - File manually deleted at OS level.
    - File moved/renamed outside RMAN.


_To check expired backups:_
```
list expired backup;
```


```
CROSSCHECK BACKUP;
```


_To old delete backups:_
```
delete expired backup;

DELETE NOPROMPT EXPIRED BACKUP;
```


#### Delete Expired Archivelogs:

```
CROSSCHECK ARCHIVELOG ALL;
```


```
list expired ARCHIVELOG ALL;
```


```
DELETE EXPIRED ARCHIVELOG ALL;
```



#### Delete Obsolete Backups:
The general meaning of OBSOLETE is **no longer used or required**. RMAN considers backups as OBSOLETE when they are no longer required for database recovery. This is done by one of the RMAN CONFIGURATION parameters. A backup is OBSOLETE when it is **no longer needed to meet the retention policy**.

- Causes:
    - Retention policy says older backups are unnecessary (e.g., `RECOVERY WINDOW OF 7` DAYS or `REDUNDANCY 2`).
    - File may still exist on disk, but RMAN considers it unnecessary for recovery.


_To check obsolete backups based on the rentention policy:_
```
REPORT OBSOLETE;
```


```
REPORT NEED BACKUP DAYS 7;            --> who would violate your window
```


_Removes obsolete or unwanted backups:_
```
DELETE OBSOLETE;

DELETE NOPROMPT OBSOLETE;             --> per retention policy
```





---
---




### Restore and Recovery:

#### Restore Full Database:

```
rman target /

STARTUP MOUNT;
```


```
RESTORE DATABASE;

RECOVER DATABASE;

ALTER DATABASE OPEN;
```



#### Restore archive logs:

```
RESTORE ARCHIVELOG ALL;
```



#### Restore Control File:

```
restore controlfile from autobackup; 

restore controlfile from /u01/backup/rman/rman_bkp/cf_ORCL_c-1738843157-20250907-08; 
```


#### Restore SPFILE: 

```
restore spfile from '/u01/backup/rman/rman_bkp/cf_ORCL_c-1738843157-20250909-00';
```




#### Restore Specific Tablespace: 

```
RESTORE TABLESPACE users;
RECOVER TABLESPACE users;
```


#### Restore Specific Datafile:

```
RESTORE DATAFILE 5;
RECOVER DATAFILE 5;

RESTORE DATAFILE ‘/dboracle/customer.dbf’;
```



#### Restore a specific table:

```
RESTORE TABLESPACE customer;
```





#### Point-in-Time Recovery:
```
RUN {
  SET UNTIL TIME "TO_DATE('2025-09-06 12:00:00','YYYY-MM-DD HH24:MI:SS')";
  RESTORE DATABASE;
  RECOVER DATABASE;
}
```



---
---





### Troubleshooting:




Oracle RMAN provides a complete solution for **database backup and recovery**. It simplifies backup management by automating control file, SPFILE, and archive log handling, while offering flexible options such as full, incremental, and image copy backups.  

